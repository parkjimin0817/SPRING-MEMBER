<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.brenex.pjm.mapper.MemberMapper">
    <resultMap type="Member" id="memberResultMap">
        <!-- <result column="테이블의 컬럼명" property="객체의 필드명"/> -->
        <result column="MEMBER_NO" property="memberNo"/>
        <result column="MEMBER_ID" property="memberId"/>
        <result column="MEMBER_PWD" property="memberPwd"/>
        <result column="NAME" property="name"/>
        <result column="GENDER" property="gender"/>
        <result column="AGE" property="age"/>
        <result column="ZIP_CODE" property="zipCode"/>
        <result column="ADDRESS_BASE" property="addressBase"/>
        <result column="ADDRESS_DETAIL" property="addressDetail"/>
        <result column="PHONE" property="phone"/>
        <result column="EMAIL" property="email"/>
        <result column="MEMBER_STATUS" property="memberStatus"/>
        <result column="MEMBER_ROLE" property="memberRole"/>
        <result column="CREATED_DATE" property="createdDate"/>
        <result column="MODIFY_DATE" property="modifyDate"/>
        <result column="ANONYMIZED_YN" property="anonymizedYN"/>
        <result column="ANONYMIZED_DATE" property="anonymizedDate"/>
        <result column="CHANGED_REASON" property="changedReason"/>
        <result column="CHANGED_DATE" property="changedDate"/>
    </resultMap>
    <!--회원가입-->
    <insert id="insertMember" parameterType="Member"
            useGeneratedKeys="true"
            keyProperty="memberNo"
            keyColumn="MEMBER_NO">
        INSERT INTO MEMBER(
            MEMBER_ID,
            MEMBER_PWD,
            NAME,
            GENDER,
            AGE,
            ZIP_CODE,
            ADDRESS_BASE,
            ADDRESS_DETAIL,
            PHONE,
            EMAIL
        ) VALUES (
            #{memberId},
            #{memberPwd},
            #{name},
            #{gender},
            #{age},
            #{zipCode},
            #{addressBase},
            #{addressDetail},
            #{phone},
            #{email}
        )
    </insert>
    <!-- 아이디로 멤버 로그인-->
    <select id="findByMemberId" parameterType="string" resultMap="memberResultMap">
        SELECT *
        FROM (
            SELECT M.MEMBER_NO, M.MEMBER_ID, M.MEMBER_PWD, M.MEMBER_ROLE, M.MEMBER_STATUS, H.CHANGED_REASON, H.CHANGED_DATE
            FROM MEMBER M
            LEFT JOIN MEMBER_STATUS_HISTORY H ON (M.MEMBER_NO = H.MEMBER_NO)
            WHERE MEMBER_ID = #{memberId}
            ORDER BY CHANGED_DATE DESC
        )
        WHERE ROWNUM = 1
    </select>
    <!-- 회원 목록 조회  -->
    <select id="selectMemberList" parameterType="map" resultMap="memberResultMap">
        SELECT MEMBER_NO,
                MEMBER_ID,
                MEMBER_PWD,
                NAME,
                GENDER,
                ZIP_CODE,
                ADDRESS_BASE,
                ADDRESS_DETAIL,
                AGE,
                PHONE,
                EMAIL,
                MEMBER_STATUS,
                MEMBER_ROLE,
                CREATED_DATE
                FROM MEMBER
        <where>
            <if test="status != null and status != ''">
               MEMBER_STATUS = #{status}
            </if>
            <if test="role != null and role != ''">
                AND MEMBER_ROLE = #{role}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                    LOWER(MEMBER_ID) LIKE '%' || LOWER(#{keyword}) || '%'
                    OR LOWER(EMAIL) LIKE '%' || LOWER(#{keyword}) || '%'
                    OR LOWER(ADDRESS_BASE) LIKE '%' || LOWER(#{keyword}) || '%'
                    OR LOWER(ADDRESS_DETAIL) LIKE '%' || LOWER(#{keyword}) || '%'
                )
            </if>
        </where>
        ORDER BY CREATED_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY
    </select>
    <!-- 회원 수-->
    <select id="countMembers" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM MEMBER
        <where>
            <if test="status != null and status != ''">
                AND MEMBER_STATUS = #{status}
            </if>
            <if test="role != null and role != ''">
                AND MEMBER_ROLE = #{role}
            </if>
            <if test="keyword != null and keyword != ''">
                AND (
                LOWER(MEMBER_ID) LIKE '%' || LOWER(#{keyword}) || '%'
                OR LOWER(EMAIL) LIKE '%' || LOWER(#{keyword}) || '%'
                OR LOWER(ADDRESS_BASE) LIKE '%' || LOWER(#{keyword}) || '%'
                OR LOWER(ADDRESS_DETAIL) LIKE '%' || LOWER(#{keyword}) || '%'
                )
            </if>
        </where>
    </select>
    <!-- 회원 번호로 회원 정보 조회 -->
    <select id="selectBasicMemberInfo" parameterType="int" resultMap="memberResultMap">
        SELECT MEMBER_ID,
                NAME,
                GENDER,
                AGE,
                ZIP_CODE,
                ADDRESS_BASE,
                ADDRESS_DETAIL,
                PHONE,
                EMAIL,
                CREATED_DATE,
                MEMBER_ROLE,
                MEMBER_STATUS
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
    </select>
    <!-- 상태 변경-->
    <update id="updateStatus">
        UPDATE MEMBER
        SET MEMBER_STATUS = #{status}
        WHERE MEMBER_NO IN
            <foreach collection="memberNoList" item="memberNo" open="(" separator="," close=")">
                #{memberNo}
            </foreach>
    </update>
    <!-- id로 no 찾기-->
    <select id="findMemberNoByMemberId">
        SELECT MEMBER_NO
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND MEMBER_STATUS IN ('APPROVED', 'PENDING')
    </select>
    <!-- no으로 비밀번호 찾기-->
    <select id="getPwdByMemberNo" parameterType="int">
        SELECT MEMBER_PWD
        FROM MEMBER
        WHERE MEMBER_NO = #{memberNo}
        AND MEMBER_STATUS IN ('APPROVED', 'PENDING')
    </select>
    <!--회원 상세 정보 조회-->
    <select id="selectMemberDetailWithHistory"  parameterType="int" resultMap="memberResultMap">
        SELECT *
        FROM (
            SELECT M.MEMBER_NO,
                    M.MEMBER_ID,
                    M.NAME,
                    M.GENDER,
                    M.AGE,
                    M.ZIP_CODE,
                    M.ADDRESS_BASE,
                    M.ADDRESS_DETAIL,
                    M.EMAIL,
                    M.PHONE,
                    M.CREATED_DATE,
                    M.MEMBER_ROLE,
                    M.MEMBER_STATUS,
                    H.CHANGED_REASON,
                    H.CHANGED_DATE
                FROM MEMBER M
                LEFT JOIN MEMBER_STATUS_HISTORY H ON (M.MEMBER_NO = H.MEMBER_NO)
                WHERE M.MEMBER_NO = #{memberNo}
                ORDER BY CHANGED_DATE DESC
        )WHERE ROWNUM = 1
    </select>
    <update id="updateMember" parameterType="Member">
        UPDATE MEMBER
        <set>
            <if test="memberPwd != null and memberPwd != ''">
                MEMBER_PWD = #{memberPwd},
            </if>
            <if test="gender != null and gender != ''">
                GENDER = #{gender},
            </if>
            <if test="age != null">
                AGE = #{age},
            </if>
            <if test="zipCode != null and zipCode != ''">
                ZIP_CODE = #{zipCode},
            </if>
            <if test="addressBase != null and addressBase != ''">
                ADDRESS_BASE = #{addressBase},
            </if>
            <if test="addressDetail != null and addressDetail != ''">
                ADDRESS_DETAIL = #{addressDetail},
            </if>
            <if test="phone != null and phone != ''">
                PHONE = #{phone},
            </if>
            <if test="email != null and email != ''">
                EMAIL = #{email},
            </if>
            MODIFY_DATE = SYSDATE
        </set>
        WHERE MEMBER_NO = #{memberNo}
    </update>
    <!-- 권한 변경-->
    <update id="updateRole">
        UPDATE MEMBER
        SET MEMBER_ROLE = #{role}
        WHERE MEMBER_NO = #{memberNo}
    </update>
    <!-- 중복 아이디 체크, 비밀번호 찾기 - 아이디 확인-->
    <select id="existsById" parameterType="string">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND MEMBER_STATUS IN ( 'APPROVED', 'PENDING' )
    </select>
    <!-- 비밀번호 찾기 - 이메일 확인-->
    <select id="checkEmail" parameterType="string">
        SELECT COUNT(*)
        FROM MEMBER
        WHERE MEMBER_ID = #{memberId}
        AND EMAIL = #{email}
        AND MEMBER_STATUS IN ( 'APPROVED', 'PENDING' )
    </select>
    <!--비밀번호 변경-->
    <update id="changePwd">
        UPDATE MEMBER
        SET MEMBER_PWD = #{password}
        WHERE MEMBER_NO = #{memberNo}
        AND MEMBER_STATUS IN ('APPROVED', 'PENDING')
    </update>
    <update id="anonymizeMember" parameterType="int">
        UPDATE MEMBER M
        SET M.MEMBER_ID = 'del_' || M.MEMBER_NO,
            M.MEMBER_PWD = 'deleted',
            M.NAME = '삭제회원',
            M.GENDER = NULL,
            M.AGE = NULL,
            M.ZIP_CODE = '00000',
            M.ADDRESS_BASE = '비식별 처리',
            M.ADDRESS_DETAIL = '-',
            M.EMAIL = 'del_' || M.MEMBER_NO || '@del.local' ,
            M.PHONE = '-',
            M.ANONYMIZED_YN = 'Y',
            M.ANONYMIZED_DATE    = SYSDATE
    WHERE M.MEMBER_STATUS IN('WITHDRAWN', 'DELETED')
        AND M.ANONYMIZED_YN = 'N'
        AND (
            SELECT MAX(H.CHANGED_DATE)
            FROM MEMBER_STATUS_HISTORY H
            WHERE H.MEMBER_NO = M.MEMBER_NO
            AND H.NEW_STATUS IN ('WITHDRAWN', 'DELETED')
        ) &lt;= SYSDATE - NUMTODSINTERVAL(#{minute}, 'MINUTE')
    </update>
</mapper>
